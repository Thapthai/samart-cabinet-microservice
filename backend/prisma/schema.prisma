// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "mysql"
}

model User {
  id                    Int       @id @default(autoincrement())
  email                 String    @unique
  password              String? // Optional for OAuth users
  name                  String
  is_active             Boolean   @default(true)
  email_verified        Boolean   @default(false)
  preferred_auth_method String    @default("jwt") // jwt, oauth2, api_key, firebase
  last_login_at         DateTime?

  // Firebase Authentication
  firebase_uid    String? @unique @map("firebase_uid")
  profile_picture String? @map("profile_picture")

  // 2FA Fields
  two_factor_enabled     Boolean   @default(false) @map("two_factor_enabled")
  two_factor_secret      String?   @map("two_factor_secret") // TOTP secret
  backup_codes           String?   @map("backup_codes") @db.Text // JSON string of backup codes
  two_factor_verified_at DateTime? @map("two_factor_verified_at")

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  oauth_accounts     OAuthAccount[]
  api_keys           ApiKey[]
  client_credentials ClientCredential[]
  refreshTokens      RefreshToken[]
  two_factor_tokens  TwoFactorToken[]

  @@map("app_microservice_users")
}

model StaffRole {
  id          Int      @id @default(autoincrement())
  code        String   @unique // 'it1', 'it2', 'it3', 'warehouse1', 'warehouse2', 'warehouse3'
  name        String // 'IT 1', 'IT 2', 'Warehouse 1', etc.
  description String?  @db.Text // Description of the role
  is_active   Boolean  @default(true) @map("is_active")
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // Relations
  staffUsers      StaffUser[]
  rolePermissions StaffRolePermission[]

  @@index([code], name: "idx_code")
  @@index([is_active], name: "idx_is_active")
  @@map("app_microservice_staff_roles")
}

model StaffUser {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  fname         String // First name
  lname         String // Last name
  department_id Int?      @map("department_id") // Department ID
  role_id       Int       @map("role_id") // Foreign key to StaffRole
  password      String // Hashed password, default: password123
  client_id     String    @unique @map("client_id") // For API access
  client_secret String    @map("client_secret") // Hashed secret
  expires_at    DateTime? @map("expires_at") // Client credential expiration
  is_active     Boolean   @default(true) @map("is_active")
  created_at    DateTime  @default(now()) @map("created_at")
  updated_at    DateTime  @updatedAt @map("updated_at")

  // Relations
  role       StaffRole   @relation(fields: [role_id], references: [id])
  department Department? @relation(fields: [department_id], references: [ID])

  @@index([role_id], name: "idx_role_id")
  @@index([email], name: "idx_email")
  @@index([is_active], name: "idx_is_active")
  @@index([department_id], name: "idx_department_id")
  @@map("app_microservice_staff_users")
}

model StaffRolePermission {
  id         Int      @id @default(autoincrement())
  role_id    Int      @map("role_id") // Foreign key to StaffRole
  menu_href  String   @map("menu_href") // Menu href path, e.g., '/staff/dashboard'
  can_access Boolean  @default(true) @map("can_access")
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  role StaffRole @relation(fields: [role_id], references: [id])

  @@unique([role_id, menu_href], name: "role_menu_href")
  @@index([role_id], name: "idx_role_id")
  @@index([menu_href], name: "idx_menu_href")
  @@map("app_microservice_staff_role_permissions")
}

model OAuthAccount {
  id            Int       @id @default(autoincrement())
  user_id       Int       @map("user_id")
  provider      String // google, github, facebook, etc.
  provider_id   String    @map("provider_id")
  access_token  String?   @map("access_token") @db.Text
  refresh_token String?   @map("refresh_token") @db.Text
  expires_at    DateTime? @map("expires_at")
  token_type    String?   @map("token_type")
  scope         String?
  created_at    DateTime  @default(now()) @map("created_at")
  updated_at    DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([provider, provider_id])
  @@map("app_microservice_oauth_accounts")
}

model ApiKey {
  id           Int       @id @default(autoincrement())
  user_id      Int       @map("user_id")
  name         String
  description  String?
  key_hash     String    @unique @map("key_hash")
  prefix       String // First 8 chars for identification
  is_active    Boolean   @default(true) @map("is_active")
  last_used_at DateTime? @map("last_used_at")
  expires_at   DateTime? @map("expires_at")
  created_at   DateTime  @default(now()) @map("created_at")
  updated_at   DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("app_microservice_api_keys")
}

model ClientCredential {
  id                 Int       @id @default(autoincrement())
  user_id            Int       @map("user_id")
  name               String
  description        String?
  client_id          String    @unique @map("client_id")
  client_secret_hash String    @map("client_secret_hash")
  is_active          Boolean   @default(true) @map("is_active")
  last_used_at       DateTime? @map("last_used_at")
  expires_at         DateTime? @map("expires_at")
  created_at         DateTime  @default(now()) @map("created_at")
  updated_at         DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([client_id])
  @@map("app_microservice_client_credentials")
}

model RefreshToken {
  id         Int      @id @default(autoincrement())
  user_id    Int      @map("user_id")
  token      String   @unique
  expires_at DateTime @map("expires_at")
  is_revoked Boolean  @default(false) @map("is_revoked")
  created_at DateTime @default(now()) @map("created_at")

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("app_microservice_refresh_tokens")
}

model TwoFactorToken {
  id         Int      @id @default(autoincrement())
  user_id    Int      @map("user_id")
  token      String
  type       String // 'email_otp', 'sms_otp', 'backup_code'
  expires_at DateTime @map("expires_at")
  isUsed     Boolean  @default(false) @map("is_used")
  created_at DateTime @default(now()) @map("created_at")

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, type])
  @@map("app_microservice_two_factor_tokens")
}

model Category {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  slug        String   @unique
  image       String?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  @@map("app_microservice_categories")
}

model Item {
  itemcode                 String    @id @db.VarChar(25)
  itemname                 String?   @db.VarChar(255)
  Alternatename            String?   @db.VarChar(100)
  Barcode                  String?   @db.VarChar(50)
  IsSet                    String?   @db.VarChar(1)
  IsReuse                  String?   @db.VarChar(1)
  IsNormal                 String?   @default("1") @db.VarChar(1)
  itemtypeID               Int?
  UnitID                   Int?      @default(0)
  SpecialID                Int?      @default(0)
  DepartmentID             Int?      @default(0)
  ShelfLifeID              Int?      @default(0)
  SetCount                 Int?      @default(0)
  PackingMatID             Int?      @default(0)
  CostPrice                Decimal?  @db.Decimal(10, 2)
  SalePrice                Decimal?  @db.Decimal(10, 2)
  UsagePrice               Decimal?  @db.Decimal(10, 2)
  SterileMachineID         Int?      @default(0)
  SterileProcessID         Int?      @default(0)
  WashMachineID            Int?      @default(0)
  WashProcessID            Int?      @default(0)
  SupllierID               Int?      @default(0)
  FactID                   Int?      @default(0)
  LabelID                  Int?      @default(0)
  Minimum                  Int?      @default(0)
  Maximum                  Int?      @default(0)
  weight                   Decimal?  @db.Decimal(10, 2)
  IsSpecial                String?   @default("0") @db.VarChar(1)
  LabelGroupID             Int?
  Picture                  String?   @db.VarChar(100)
  Picture2                 String?   @db.VarChar(100)
  NoWash                   Boolean?  @default(false)
  IsWashDept               Int?      @default(0)
  PriceID                  Int?      @default(0)
  itemcode2                String?   @db.VarChar(20)
  IsNonUsage               Boolean?  @default(false)
  itemcode3                String?   @db.VarChar(20)
  IsPrintDepartment        Boolean?  @default(true)
  IsStock                  Boolean?  @default(true)
  IsRecieveRecordOnly      Boolean?  @default(false)
  IsWasting                Boolean?  @default(false)
  IsCheckList              Boolean?  @default(false)
  RoundOfTimeUsed          Int?      @default(0)
  NoWashType               Int?      @default(0)
  CreateDate               DateTime? @default(now())
  IsCSSDComfirm            Int?      @default(0)
  IsDenger                 Int?      @default(0)
  IsInternalIndicatorCheck Int?      @default(0)
  IsFillterCheck           Int?      @default(0)
  IsLabelingCheck          Int?      @default(0)
  IsLoaner                 Int?
  LimitUse                 Int?      @default(0)
  PayDep                   Int?      @default(0)
  IsRemarkRound            Int?      @default(0)
  IsReceiveNotSterile      Boolean?  @default(true)
  IsReceiveManual          Boolean?  @default(true)
  RefNo                    String?
  IsCancel                 Int?      @default(0)
  IsSingle                 Boolean?  @default(false)
  IsNotShowSendSterile     Boolean?  @default(false)
  Store                    String?
  PackingMat               String?
  ShelfLife                Int?      @default(0)
  ManufacturerName         String?
  item_data_1_id           Int?
  InternalCode             String?
  ManufacturerMemo         String?
  item_data_1              Int?
  Picweb                   String?   @db.MediumText
  SuplierName              String?
  IsNoSterile              Boolean?  @default(false)
  IsShowQrItemCode         Boolean?  @default(false)
  SuplierNameMemo          String?
  IsSingleUsage            Boolean?  @default(false)
  ListUnderLineNo          String?
  Isopdipd                 Int?
  Note                     String?   @db.Text
  B_ID                     Int?
  ListColorLineNo          String?
  IsPrintNoSterile         Boolean?  @default(false)
  IsPayToSend              Int?
  IsTrackAuto              Boolean?  @default(false)
  IsGroupPrintSticker      Boolean?  @default(false)
  FileUpload               String?   @db.Text
  IsUsageName              Boolean?  @default(false)
  Typeitemcode             Int?
  Picture3                 String?   @db.Text
  Picture4                 String?   @db.Text
  Picture5                 String?   @db.Text
  IsFabric                 Boolean?  @default(false)
  WashPriceId              Int?
  SterilePriceId           Int?
  ReProcessPrice           Float?
  wash_price_id            Int?
  sterile_price_id         Int?
  reprocess_price          Float?
  UserCreate               Int?      @default(0)
  UserModify               Int?      @default(0)
  ModiflyDate              DateTime? @default(now())
  IsNumber                 Boolean?  @default(false)
  SapCode                  String?
  IsChangeUsageInSet       Boolean?  @default(false)
  IsNH                     Int?
  MaxInventory             Int?
  procedureID              Int?
  Description              String?   @db.Text
  ReuseDetect              String?
  stock_max                Int?
  stock_min                Int?
  stock_balance            Int?
  warehouseID              Int?
  fixcost                  Boolean?  @default(false)
  main_max                 Int?
  main_min                 Int?
  item_status              Int?      @default(0)

  // Relations
  itemType                ItemType?                 @relation(fields: [itemtypeID], references: [ID], onDelete: SetNull)
  itemStocks              ItemStock[]
  itemSlotInCabinet       ItemSlotInCabinet[]
  itemSlotInCabinetDetail ItemSlotInCabinetDetail[] @relation("DetailToItem")

  @@index([itemtypeID])
  @@map("item")
}

// Medical Supplies Usage
model MedicalSupplyUsage {
  id Int @id @default(autoincrement())

  // Hospital & Episode Info
  hospital String? @map("hospital") // VTN01
  en       String? @default("") @map("en") // Episode Number (EZ5-000584)

  // Patient Information
  patient_hn String  @map("patient_hn") // HN Hospital Number (20-010334)
  first_name String? @default("") @map("first_name") // ชื่อจริง
  lastname   String? @default("") @map("lastname") // นามสกุล

  // Legacy fields (for backward compatibility)
  patient_name_th String? @map("patient_name_th")
  patient_name_en String? @map("patient_name_en")

  // Usage Details
  usage_datetime String? @map("usage_datetime")
  usage_type     String? @map("usage_type")
  purpose        String? @map("purpose")

  // Location
  department_code String? @map("department_code")

  // Personnel
  recorded_by_user_id String? @map("recorded_by_user_id")

  // Billing
  billing_status   String? @map("billing_status")
  billing_subtotal Float?  @map("billing_subtotal")
  billing_tax      Float?  @map("billing_tax")
  billing_total    Float?  @map("billing_total")
  billing_currency String? @default("THB") @map("billing_currency")

  // Print Information (ข้อมูลการ Print - ระดับ Usage Record)
  twu             String? @map("twu") // Patient Location when Ordered (แผนก/จุดที่ Print ตาม Location ที่ผู้ป่วยได้รับการ Key รายการ Order)
  print_location  String? @map("print_location") // Print Location when Ordered (Emergency)
  print_date      String? @map("print_date") // Print Date (14/11/2025)
  time_print_date String? @map("time_print_date") // Time Print Date (14/11/2025 09:30:00)
  update          String? @map("update") // Print Date - วันที่ของการ Print แยกจากวันที่ Receipt /Invoice

  // Timestamps
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  supply_items SupplyUsageItem[]
  logs         MedicalSupplyUsageLog[]

  @@index([patient_hn])
  @@index([en])
  @@index([usage_datetime])
  @@index([department_code])
  @@index([billing_status])
  @@map("app_microservice_medical_supply_usages")
}

// Supply Usage Items (Order Items)
model SupplyUsageItem {
  id                      Int @id @default(autoincrement())
  medical_supply_usage_id Int @map("medical_supply_usage_id")

  // Order Item Details (New Format from API Spec)
  order_item_code        String? @default("") @map("order_item_code") // ItemCode (S4214JELCO018)
  order_item_description String? @default("") @map("order_item_description") // ItemDescription (JELCO IV NO,18)
  assession_no           String? @default("") @map("assession_no") // Assession No. (17938884/109)
  order_item_status      String? @default("") @map("order_item_status") // Order Item Status (Verified, Update, etc.)
  qty                    Int?    @default(0) @map("qty") // Quantity
  uom                    String? @default("") @map("uom") // Unit of Measure (Each)

  // Legacy fields (for backward compatibility)
  supply_code     String? @map("supply_code")
  supply_name     String? @map("supply_name")
  supply_category String? @map("supply_category")
  unit            String? @map("unit")
  quantity        Int?    @map("quantity")
  unit_price      Float?  @map("unit_price")
  total_price     Float?  @map("total_price")
  expiry_date     String? @map("expiry_date")

  // Quantity Management - แยกจำนวนอุปกรณ์ตามการใช้งาน
  qty_used_with_patient   Int @default(0) @map("qty_used_with_patient") // จำนวนที่ใช้กับคนไข้
  qty_returned_to_cabinet Int @default(0) @map("qty_returned_to_cabinet") // จำนวนที่คืนเข้าตู้แล้ว
  // qty_pending = qty - qty_used_with_patient - qty_returned_to_cabinet (คำนวณได้)

  // Status Management
  item_status String @default("PENDING") @map("item_status") // PENDING, PARTIAL, COMPLETED

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  usage MedicalSupplyUsage @relation(fields: [medical_supply_usage_id], references: [id], onDelete: Cascade)
  // return_items SupplyItemReturnRecord[]

  @@index([medical_supply_usage_id])
  @@index([order_item_code])
  @@index([assession_no])
  @@index([supply_code])
  @@index([item_status])
  @@map("app_microservice_supply_usage_items")
}

// Supply Item Return Records - บันทึกรายการคืนอุปกรณ์แต่ละครั้ง
model SupplyItemReturnRecord {
  id Int @id @default(autoincrement())

  itemCode String @map("item_code")
  stock_id Int?   @map("stock_id") // optional: รายการเก่าอาจไม่มี; ใช้ร่วมกับ cabinet.stock_id เมื่อมี

  // Return Details
  qty_returned      Int      @map("qty_returned") // จำนวนที่คืนในครั้งนี้
  return_reason     String   @map("return_reason") // UNWRAPPED_UNUSED, EXPIRED, CONTAMINATED, DAMAGED
  return_datetime   DateTime @default(now()) @map("return_datetime")
  return_by_user_id String   @map("return_by_user_id")
  return_note       String?  @map("return_note") // หมายเหตุเพิ่มเติม

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relation: ระบุว่าคืนมาจากตู้ไหน (ผ่าน stock_id = cabinet.stock_id)
  cabinet cabinet? @relation(fields: [stock_id], references: [stock_id])

  @@index([itemCode], map: "idx_return_itemCode")
  @@index([stock_id])
  @@map("app_microservice_supply_item_return_records")
}

// Medical Supplies Usage Logs
model MedicalSupplyUsageLog {
  id Int @id @default(autoincrement())

  // Reference to the usage record (nullable for error logs)
  usage_id Int? @map("usage_id")

  // Action data (JSON) - เก็บทุกอย่างใน JSON
  action Json @map("action") @db.Json

  // Timestamp
  created_at DateTime @default(now()) @map("created_at")

  // Relations (optional - for error logs without usage_id)
  usage MedicalSupplyUsage? @relation(fields: [usage_id], references: [id], onDelete: Cascade)

  @@index([usage_id])
  @@index([created_at])
  @@map("app_microservice_medical_supply_usages_logs")
}

// Item Stock (Inventory Management)
model ItemStock {
  RowID                 Int       @id @default(autoincrement()) @map("RowID")
  CreateDate            DateTime? @default(now()) @map("CreateDate")
  ItemCode              String?   @map("ItemCode") @db.VarChar(20)
  UsageCode             String?   @map("UsageCode") @db.VarChar(20)
  UsageCode2            String?   @map("UsageCode2") @db.VarChar(20)
  RfidCode              String?   @map("RfidCode") @db.VarChar(255)
  IsStatus              Int?      @default(0) @map("IsStatus")
  IsNew                 Boolean?  @default(true) @map("IsNew")
  IsNewUsage            Boolean?  @default(true) @map("IsNewUsage")
  LastSendDeptDate      DateTime? @map("LastSendDeptDate")
  PackDate              DateTime? @map("PackDate")
  ExpireDate            DateTime? @map("ExpireDate")
  DepID                 Int?      @default(0) @map("DepID")
  PackingMatID          Int?      @map("PackingMatID")
  Qty                   Int?      @default(0) @map("Qty")
  UsageCount            Int?      @default(0) @map("UsageCount")
  IsPay                 Int?      @default(0) @map("IsPay")
  LastPayDeptDate       DateTime? @map("LastPayDeptDate")
  IsDispatch            Boolean?  @default(false) @map("IsDispatch")
  LastReceiveDeptDate   DateTime? @map("LastReceiveDeptDate")
  IsTag                 Boolean?  @default(false) @map("IsTag")
  IsNoStep12            Boolean?  @default(false) @map("IsNoStep12")
  IsPrint               Boolean?  @default(false) @map("IsPrint")
  IsCancel              Boolean?  @default(false) @map("IsCancel")
  B_ID                  Int?      @default(0) @map("B_ID")
  ImportOccurrenceID    Int?      @default(0) @map("ImportOccurrenceID")
  LastSterileDetailID   Int?      @map("LastSterileDetailID")
  LastReceiveInDeptDate DateTime? @map("LastReceiveInDeptDate")
  LastDispatchModify    DateTime? @map("LastDispatchModify")
  IsHN                  Int?      @default(0) @map("IsHN")
  IsStock               Boolean?  @default(true) @map("IsStock")
  IsBorrow              Boolean?  @default(false) @map("IsBorrow")
  PreviousStatus        Int?      @default(0) @map("PreviousStatus")
  IsWeb                 Int?      @default(0) @map("IsWeb")
  IsRemarkExpress       Int?      @default(0) @map("IsRemarkExpress")
  RemarkExpress         String?   @map("RemarkExpress") @db.VarChar(255)
  IsReuse               Int?      @default(1) @map("IsReuse")
  IsTrade               Boolean?  @default(false) @map("IsTrade")
  IsDeposit             Int?      @default(0) @map("IsDeposit")
  TransactionCreate     Int?      @map("TransactionCreate")
  DeptID                Int?      @default(0) @map("DeptID")
  isPairing             Boolean?  @default(false) @map("isPairing")
  PreviousIsPay         Boolean?  @default(false) @map("PreviousIsPay")
  IsREUsageCount        Boolean?  @default(false) @map("IsREUsageCount")
  IsCancelByLimit       Boolean?  @default(false) @map("IsCancelByLimit")
  UsageName             String?   @map("UsageName") @db.VarChar(255)
  ProductSerial         String?   @map("ProductSerial") @db.VarChar(25)
  StockID               Int?      @map("StockID")
  HNCode                String?   @map("HNCode") @db.VarChar(20)
  CabinetUserID         Int?      @map("CabinetUserID")
  LastCabinetModify     DateTime? @map("LastCabinetModify")
  InsertRfidDocNo       String?   @map("InsertRfidDocNo") @db.VarChar(20)
  Istatus_rfid          Int?      @map("Istatus_rfid") // 1=เดิม 2=เบิก 3=ส่ง
  ShiptoDate            DateTime? @map("ShiptoDate")
  ReturnDate            DateTime? @map("ReturnDate")
  InsertDate            DateTime? @map("InsertDate")
  IsDeproom             String?   @map("IsDeproom") @db.VarChar(5)
  IsClaim               Int?      @map("IsClaim")
  IsCross               Int?      @map("IsCross")
  departmentroomId      Int?      @map("departmentroomId")
  IsDamage              Int?      @map("IsDamage")
  lotNo                 String?   @map("lotNo") @db.VarChar(50)
  expDate               DateTime? @map("expDate")
  IsTracking            Boolean?  @default(false) @map("IsTracking")
  remarkTracking        String?   @map("remarkTracking") @db.VarChar(255)
  return_userID         Int?      @map("return_userID")
  IsSell                Int?      @default(0) @map("IsSell")

  // Relations
  item    Item?    @relation(fields: [ItemCode], references: [itemcode], onDelete: SetNull)
  cabinet cabinet? @relation(fields: [StockID], references: [stock_id])

  @@map("itemstock")
}

// Item Type (Type of Medical Supplies)
model ItemType {
  ID       Int      @id @default(autoincrement()) @map("ID")
  TypeName String?  @map("TypeName") @db.VarChar(50)
  IsCancel Boolean? @default(false) @map("IsCancel")
  B_ID     Int?     @map("B_ID")

  // Relations
  items Item[]

  @@map("itemtype")
}

// Department
model Department {
  ID                Int     @id @default(autoincrement()) @map("ID")
  DepName           String? @map("DepName") @db.VarChar(200)
  DepName2          String? @map("DepName2") @db.VarChar(200)
  IsCancel          Int?    @default(0) @map("IsCancel")
  DivID             Int?    @map("DivID")
  PriorityNo        Int?    @map("PriorityNo")
  IsRepeat          Int?    @default(0) @map("IsRepeat")
  IsAutomaticPayout Int?    @default(0) @map("IsAutomaticPayout")
  Is_Bnew           Int?    @default(0) @map("Is_Bnew")
  Floor             String? @map("Floor") @db.VarChar(50)
  package           Int?    @map("package")
  Tel               String? @map("Tel") @db.VarChar(50)
  IsReceiveManual   Int?    @default(0) @map("IsReceiveManual")
  IsNoCopyPayout    Int?    @default(0) @map("IsNoCopyPayout")
  sort              Int?    @map("sort")
  B_IDimed          Int?    @map("B_IDimed")
  DepNameimed       String? @map("DepNameimed") @db.VarChar(200)
  LendingLimitDay   Int?    @map("LendingLimitDay")
  IsMainDep         Int?    @default(0) @map("IsMainDep")
  ItemPrefix        String? @map("ItemPrefix") @db.VarChar(20)
  B_ID              Int?    @map("B_ID")
  IsAutoStock       Int?    @default(0) @map("IsAutoStock")
  IsGroupHoldFromHN Int?    @default(0) @map("IsGroupHoldFromHN")
  ExpiringSoonDay   Int?    @map("ExpiringSoonDay")
  IsToStock         Int?    @default(0) @map("IsToStock")
  IsLaundy          Int?    @default(0) @map("IsLaundy")
  IsLoaner          Int?    @default(0) @map("IsLoaner")
  IsStock           Int?    @default(0) @map("IsStock")
  RefDepID          String? @map("RefDepID") @db.VarChar(50)

  // Relations
  staffUsers         StaffUser[]
  cabinetDepartments cabinetDepartment[]

  @@map("department")
}

model cabinet {
  id             Int      @id @default(autoincrement())
  cabinet_name   String?  @map("cabinet_name") @db.VarChar(255)
  cabinet_code   String?  @map("cabinet_code") @db.VarChar(255)
  cabinet_type   String?  @map("cabinet_type") @db.VarChar(255)
  cabinet_status String?  @default("ACTIVE") @map("cabinet_status") @db.VarChar(255)
  stock_id       Int?     @unique() @map("stock_id")
  created_at     DateTime @default(now()) @map("created_at")
  updated_at     DateTime @updatedAt @map("updated_at")

  cabinetDepartments      cabinetDepartment[]
  itemStocks              ItemStock[]
  supplyItemReturnRecords SupplyItemReturnRecord[]
  cabinetItemSettings     CabinetItemSetting[]
  itemSlotInCabinet       ItemSlotInCabinet[]

  @@map("app_microservice_cabinets")
}

// Min/Max ต่อตู้ — override ของ item.stock_min/stock_max เมื่อมีแถวสำหรับ (cabinet_id, item_code)
model CabinetItemSetting {
  id         Int      @id @default(autoincrement())
  cabinet_id Int      @map("cabinet_id")
  item_code  String   @map("item_code") @db.VarChar(25)
  stock_min  Int?     @map("stock_min")
  stock_max  Int?     @map("stock_max")
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  cabinet cabinet @relation(fields: [cabinet_id], references: [id], onDelete: Cascade)

  @@unique([cabinet_id, item_code])
  @@index([cabinet_id])
  @@index([item_code])
  @@map("app_microservice_cabinet_item_settings")
}

model cabinetDepartment {
  id            Int     @id @default(autoincrement())
  cabinet_id    Int?    @map("cabinet_id")
  department_id Int?    @map("department_id")
  status        String  @default("ACTIVE") @map("status") // ACTIVE, INACTIVE
  description   String? @map("description") @db.Text

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  cabinet    cabinet?    @relation(fields: [cabinet_id], references: [id])
  department Department? @relation(fields: [department_id], references: [ID])

  @@map("app_microservice_cabinet_departments")
}

model ItemSlotInCabinet {
  id       Int    @id @default(autoincrement())
  itemcode String @unique() @map("itemcode") @db.VarChar(25)
  StockID  Int    @map("StockID")
  SlotNo   Int    @map("SlotNo")
  Sensor   Int    @map("Sensor")
  Qty      Int    @map("Qty")

  // Relations
  itemSlotInCabinetDetail ItemSlotInCabinetDetail[] @relation("DetailToSlot")
  cabinet                 cabinet?                  @relation(fields: [StockID], references: [stock_id])
  item                    Item?                     @relation(fields: [itemcode], references: [itemcode])

  @@map("itemslotincabinet")
}

model ItemSlotInCabinetDetail {
  id         Int      @id @default(autoincrement())
  Sel        Int      @map("Sel")
  itemcode   String   @map("itemcode") @db.VarChar(25)
  HnCode     String   @map("HnCode") @db.VarChar(25)
  StockID    Int      @map("StockID")
  SlotNo     Int      @map("SlotNo")
  Sensor     Int      @map("Sensor")
  Qty        Int      @map("Qty")
  ModifyDate DateTime @map("ModifyDate")
  UserID     Int      @map("UserID")
  IsDeproom  String   @map("IsDeproom") @db.VarChar(25)
  Sign       String   @map("Sign")

  // Relations
  itemSlotInCabinet ItemSlotInCabinet @relation("DetailToSlot", fields: [itemcode], references: [itemcode], map: "detail_to_slot_fkey")
  item             Item?             @relation("DetailToItem", fields: [itemcode], references: [itemcode], map: "detail_to_item_fkey")
  userCabinet      UserCabinet?      @relation(fields: [UserID], references: [cabinet_finger_id])

  @@map("itemslotincabinet_detail")
}

// user_cabinet: links cabinet_finger_id (UserID in detail) to user_id -> users -> employee
model UserCabinet {
  id                Int    @id @default(autoincrement())
  cabinet_finger_id Int    @unique @map("cabinet_finger_id")
  user_id           Int    @map("user_id")

  legacyUser        LegacyUsers           @relation(fields: [user_id], references: [id])
  itemSlotInCabinetDetail ItemSlotInCabinetDetail[]

  @@map("user_cabinet")
}

// users (legacy) - links to employee by EmpCode
model LegacyUsers {
  id       Int     @id @default(autoincrement())
  EmpCode  String? @unique @map("EmpCode") @db.VarChar(20)

  userCabinet UserCabinet[]
  employee    Employee?   @relation(fields: [EmpCode], references: [EmpCode])

  @@map("users")
}

model Employee {
  EmpCode   String @id @map("EmpCode") @db.VarChar(20)
  FirstName String? @map("FirstName") @db.VarChar(100)
  LastName  String? @map("LastName") @db.VarChar(100)

  legacyUsers LegacyUsers[]

  @@map("employee")
}
